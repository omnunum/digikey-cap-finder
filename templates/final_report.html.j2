<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Best Capacitors from Digi-Key</title>
  <style>
    /* Shared table styles */
    table.main-table, .ru-table {
      border-collapse: collapse;
      width: 100%;
      table-layout: fixed;
    }
    table.main-table th, table.main-table td,
    .ru-table th, .ru-table td {
      border: 1px solid #999;
      padding: 6px;
      text-align: center;
    }
    table.main-table th {
      background-color: #ddd;
    }
    /* Runner-ups table: alternate rows with white/light blue */
    .ru-table tr:nth-child(even) {
      background-color: #ccf;
    }
    .ru-table tr:nth-child(odd) {
      background-color: white;
    }
    /* Dimmed style for non-focused best rows */
    .dimmed {
      filter: brightness(70%);
    }
    /* Label cell: contains a truncated element plus a hover overlay */
    .label-cell {
      position: relative;
      cursor: pointer;
    }
    .label-cell .truncated {
      max-width: 100%;
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
    }
    .label-cell .full-label {
      display: none;
      position: absolute;
      left: 0;
      top: 50%;
      transform: translateY(-50%);
      background: white;
      border: 1px solid #999;
      padding: 5px;
      z-index: 100;
      white-space: normal;
      max-width: 300px;
    }
    .label-cell.has-overflow:hover .full-label {
      display: block;
    }
    /* Fixed column widths */
    col.label         { width: 8%; }
    col.qty           { width: 4%; }
    col.manuf         { width: 9%; }
    col.series        { width: 4.5%; }
    col.partnum       { width: 15%; }
    col.cap           { width: 5%; }
    col.volt          { width: 5%; }
    col.ripple        { width: 5%; }
    col.esr           { width: 5%; }
    col.lifetime      { width: 5%; }
    col.temp          { width: 5%; }
    col.diam          { width: 5%; }
    col.height        { width: 5%; }
    col.price         { width: 5%; }
    col.score         { width: 5%; }
    col.score_comp    { width: 5%; }
    col.optimize      { width: 4%; }
    col.toggle        { width: 4%; }
    
    /* Optimization indicator style */
    .optimize-indicator {
      font-weight: bold;
      padding: 2px 5px;
      border-radius: 3px;
    }
    .optimize-rc {
      background-color: #d9f2e6;
      color: #006633;
    }
    .optimize-z {
      background-color: #e6e6ff;
      color: #000066;
    }
    
    /* Score component columns toggling */
    .score-components {
      display: none;
    }
    
    .toggle-score {
      cursor: pointer;
      display: inline-block;
      margin-left: 5px;
      width: 16px;
      height: 16px;
      line-height: 16px;
      text-align: center;
      background-color: #f0f0f0;
      border-radius: 3px;
      font-weight: bold;
      font-size: 10px;
    }
    
    .toggle-score:hover {
      background-color: #e0e0e0;
    }
  </style>
  <script>
    document.addEventListener("DOMContentLoaded", function() {
      const labelCells = document.querySelectorAll('.label-cell .truncated');
      labelCells.forEach(function(el) {
        if (el.scrollWidth > el.clientWidth) {
          el.parentNode.classList.add('has-overflow');
        }
      });
    });

    function toggleRunnerUps(id, btn) {
      let ruRow = document.getElementById(id);
      let isVisible = ruRow.style.display !== 'none';
      let mainRow = btn.closest('.main-row');
      let indexVal = mainRow.getAttribute('data-index');
      
      if (isVisible) {
        ruRow.style.display = 'none';
        btn.innerHTML = "⏷";
        document.querySelectorAll('.main-row').forEach(function(row) {
          row.classList.remove('dimmed');
        });
      } else {
        ruRow.style.display = 'table-row';
        btn.innerHTML = "⏶";
        document.querySelectorAll('.main-row').forEach(function(row) {
          if (row.getAttribute('data-index') !== indexVal) {
            row.classList.add('dimmed');
          } else {
            row.classList.remove('dimmed');
          }
        });
      }
    }
    
    function toggleScoreColumns() {
      const scoreColumns = document.querySelectorAll('.score-components');
      const isVisible = scoreColumns[0].style.display !== 'none';
      
      scoreColumns.forEach(function(col) {
        col.style.display = isVisible ? 'none' : 'table-cell';
      });
      
      // Update all toggle buttons
      const toggleBtns = document.querySelectorAll('.toggle-score');
      toggleBtns.forEach(function(btn) {
        btn.innerHTML = isVisible ? "+" : "-";
      });
    }
    
    function toggleBulkOrder() {
      let el = document.getElementById('bulkOrder');
      el.style.display = (el.style.display === 'none' ? 'block' : 'none');
    }
  </script>
</head>
<body>

  <h2>Best Capacitors from Digi-Key</h2>

  <!-- Main table with an extra leftmost column for Label(s) -->
  <table class="main-table">
    <colgroup>
      <col class="label" />
      <col class="qty" />
      <col class="manuf" />
      <col class="series" />
      <col class="partnum" />
      <col class="cap" />
      <col class="volt" />
      <col class="ripple" />
      <col class="esr" />
      <col class="lifetime" />
      <col class="temp" />
      <col class="diam" />
      <col class="height" />
      <col class="price" />
      <col class="score" />
      <col class="score_comp" />
      <col class="score_comp" />
      <col class="score_comp" />
      <col class="score_comp" />
      <col class="score_comp" />
      <col class="score_comp" />
      <col class="score_comp" />
      <col class="optimize" />
      <col class="toggle" />
    </colgroup>
    
    <thead>
      <tr>
        <th>Label(s)</th>
        <th>Qty</th>
        <th>Manufacturer</th>
        <th>Series</th>
        <th>Part Number</th>
        <th>Cap (µF)</th>
        <th>Volt (V)</th>
        <th>Ripple</th>
        <th>ESR/Z</th>
        <th>Lifetime (hrs)</th>
        <th>Temp (°C)</th>
        <th>Diam (mm)</th>
        <th>Height (mm)</th>
        <th>Price (USD)</th>
        <th>Score <span class="toggle-score" onclick="toggleScoreColumns()">+</span></th>
        <th class="score-components">Ripple</th>
        <th class="score-components">ESR/Z</th>
        <th class="score-components">Lifetime</th>
        <th class="score-components">Price</th>
        <th class="score-components">Voltage</th>
        <th class="score-components">Height</th>
        <th class="score-components">Diameter</th>
        <th>Opt</th>
        <th></th>
      </tr>
    </thead>
    <tbody>
    {% for spec in specs_data %}
      {% set bg = 'white' if (loop.index0 % 2 == 0) else '#ccf' %}
      <tr class="main-row" data-index="{{ loop.index0 }}" style="background-color: {{ bg }};">
        <td class="label-cell">
          <div class="truncated">{{ spec.best.CustomerReference }}</div>
          <div class="full-label">{{ spec.best.CustomerReference }}</div>
        </td>
        <td>{{ spec.quantity|int }}</td>
        <td>{{ spec.best.Manufacturer }}</td>
        <td>{{ spec.best.Series }}</td>
        <td>{{ spec.best['Part Number Link'] | safe }}</td>
        <td>{{ spec.best.Capacitance }}</td>
        <td>{{ spec.best.Voltage }}</td>
        <td>{{ spec.best.Ripple }}</td>
        <td>{{ spec.best.ESR }}</td>
        <td>{{ spec.best.Lifetime }}</td>
        <td>{{ spec.best.Temp }}</td>
        <td>{{ spec.best.Diameter }}</td>
        <td>{{ spec.best.Height }}</td>
        <td>{{ spec.best.Price }}</td>
        <td>{{ spec.best.Composite }}</td>
        <td class="score-components">{{ spec.best.RippleScore }}</td>
        <td class="score-components">{{ spec.best.ESRScore }}</td>
        <td class="score-components">{{ spec.best.LifetimeScore }}</td>
        <td class="score-components">{{ spec.best.PriceScore }}</td>
        <td class="score-components">{{ spec.best.VoltageScore }}</td>
        <td class="score-components">{{ spec.best.HeightScore }}</td>
        <td class="score-components">{{ spec.best.DiameterScore }}</td>
        <td>
          <span class="optimize-indicator {% if spec.best.OptimizeFor == 'Ripple' %}optimize-rc{% else %}optimize-z{% endif %}">
            {{ 'RC' if spec.best.OptimizeFor == 'Ripple' else 'Z' }}
          </span>
        </td>
        <td>
          <button onclick="toggleRunnerUps('ru_{{ loop.index0 }}', this)">⏷</button>
        </td>
      </tr>
      
      <tr id="ru_{{ loop.index0 }}" style="display:none;" data-index="{{ loop.index0 }}">
        <td colspan="24" style="padding:0; border: none;">
          <!-- Runner-ups table -->
          <table class="ru-table">
            <colgroup>
              <col class="label" />
              <col class="qty" />
              <col class="manuf" />
              <col class="series" />
              <col class="partnum" />
              <col class="cap" />
              <col class="volt" />
              <col class="ripple" />
              <col class="esr" />
              <col class="lifetime" />
              <col class="temp" />
              <col class="diam" />
              <col class="height" />
              <col class="price" />
              <col class="score" />
              <col class="score_comp" />
              <col class="score_comp" />
              <col class="score_comp" />
              <col class="score_comp" />
              <col class="score_comp" />
              <col class="score_comp" />
              <col class="score_comp" />
              <col class="optimize" />
              <col class="toggle" />
            </colgroup>
            
            <thead>
              <tr>
                <th></th>
                <th></th>
                <th>Manufacturer</th>
                <th>Series</th>
                <th>Part Number</th>
                <th>Cap (µF)</th>
                <th>Volt (V)</th>
                <th>Ripple</th>
                <th>ESR/Z</th>
                <th>Lifetime (hrs)</th>
                <th>Temp (°C)</th>
                <th>Diam (mm)</th>
                <th>Height (mm)</th>
                <th>Price (USD)</th>
                <th>Score <span class="toggle-score" onclick="toggleScoreColumns()">+</span></th>
                <th class="score-components">Ripple</th>
                <th class="score-components">ESR/Z</th>
                <th class="score-components">Lifetime</th>
                <th class="score-components">Price</th>
                <th class="score-components">Voltage</th>
                <th class="score-components">Height</th>
                <th class="score-components">Diameter</th>
                <th>Opt</th>
                <th></th>
              </tr>
            </thead>
            <tbody>
            {% for ru in spec.runner_ups %}
              <tr>
                <td></td>
                <td></td>
                <td>{{ ru.Manufacturer }}</td>
                <td>{{ ru.Series }}</td>
                <td>{{ ru['Part Number Link'] | safe }}</td>
                <td>{{ ru.Capacitance }}</td>
                <td>{{ ru.Voltage }}</td>
                <td>{{ ru.Ripple }}</td>
                <td>{{ ru.ESR }}</td>
                <td>{{ ru.Lifetime }}</td>
                <td>{{ ru.Temp }}</td>
                <td>{{ ru.Diameter }}</td>
                <td>{{ ru.Height }}</td>
                <td>{{ ru.Price }}</td>
                <td>{{ ru.Composite }}</td>
                <td class="score-components">{{ ru.RippleScore }}</td>
                <td class="score-components">{{ ru.ESRScore }}</td>
                <td class="score-components">{{ ru.LifetimeScore }}</td>
                <td class="score-components">{{ ru.PriceScore }}</td>
                <td class="score-components">{{ ru.VoltageScore }}</td>
                <td class="score-components">{{ ru.HeightScore }}</td>
                <td class="score-components">{{ ru.DiameterScore }}</td>
                <td>
                  <span class="optimize-indicator {% if ru.OptimizeFor == 'Ripple' %}optimize-rc{% else %}optimize-z{% endif %}">
                    {{ 'RC' if ru.OptimizeFor == 'Ripple' else 'Z' }}
                  </span>
                </td>
                <td></td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>

  <!-- Bulk Order List dropdown -->
  <button onclick="toggleBulkOrder()">Show/Hide Bulk Order List</button>
  <div id="bulkOrder" style="display: none; margin-top: 20px;">
    <h3>Bulk Order List</h3>
    <textarea style="width: 100%; height: 150px;" readonly>
{% for spec in specs_data -%}
{{ spec.quantity|int }}, {{ spec.best.PartNumber }}, {{ spec.best.CustomerReference }}
{%- if not loop.last %}
  
{%- endif %}
{% endfor %}
    </textarea>
  </div>

  <p><strong>Total Cost (USD):</strong> {{ total_cost_str }}</p>
  <p><strong>Unique Cap Entries:</strong> {{ unique_caps }}</p>
  <p><strong>Total Quantity of Caps:</strong> {{ total_caps }}</p>

</body>
</html>
